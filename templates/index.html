<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video İndirme Yöneticisi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-sırada {
            background-color: #312e81;
            color: #e0e7ff;
        }

        .status-kaynakaranıyor,
        .status-indiriliyor {
            background-color: #78350f;
            color: #fef3c7;
        }

        .status-tamamlandı {
            background-color: #064e3b;
            color: #d1fae5;
        }

        .status-hata,
        .status-duraklatıldı {
            background-color: #991b1b;
            color: #fee2e2;
        }

        .progress-bar-container {
            background-color: #4b5563;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }

        .progress-bar {
            background-color: #4f46e5;
            height: 100%;
            text-align: center;
            color: white;
            transition: width 0.3s ease-in-out;
        }

        .btn {
            border: none;
            background-color: transparent;
            cursor: pointer;
            padding: 0;
        }

        .btn-green {
            color: #22c55e;
        }

        .btn-green:hover {
            color: #16a34a;
        }

        .btn-yellow {
            color: #eab308;
        }

        .btn-yellow:hover {
            color: #ca8a04;
        }

        .btn-blue {
            color: #3b82f6;
        }

        .btn-blue:hover {
            color: #2563eb;
        }

        .btn-purple {
            color: #a855f7;
        }

        .btn-purple:hover {
            color: #9333ea;
        }

        .btn-red {
            color: #ef4444;
        }

        .btn-red:hover {
            color: #dc2626;
        }
    </style>
</head>

<body class="bg-gray-900 font-sans text-gray-300">
    <nav class="bg-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16">
            <div class="flex items-center text-xl font-bold text-gray-200">Video İndirme Yöneticisi</div>
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('settings') }}"
                    class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700">Ayarlar</a>
                <a href="{{ url_for('logout') }}"
                    class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700">Çıkış Yap</a>
            </div>
        </div>
    </nav>
    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for category, message in messages %}
            <div class="p-4 rounded-md 
                {% if category == 'success' %} bg-green-900 border border-green-700 text-green-200
                {% elif category == 'danger' %} bg-red-900 border border-red-700 text-red-200
                {% elif category == 'warning' %} bg-yellow-900 border border-yellow-700 text-yellow-200
                {% else %} bg-indigo-900 border border-indigo-700 text-indigo-200 {% endif %}" role="alert">
                <p class="font-bold">{{ message }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-800 shadow-lg rounded-lg p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Yeni Video Ekle</h2>
                <form action="{{ url_for('add_video') }}" method="post" class="flex flex-col sm:flex-row gap-4">
                    <input type="url" name="url" placeholder="Tek film linki (https://...)"
                        class="flex-grow shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm bg-gray-700 border-gray-600 text-white rounded-md"
                        required>
                    <button type="submit"
                        class="inline-flex justify-center items-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">Sıraya
                        Ekle</button>
                </form>
            </div>
            <div class="bg-gray-800 shadow-lg rounded-lg p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Toplu Video Ekle (Liste)</h2>
                <form action="{{ url_for('add_list') }}" method="post" class="flex flex-col sm:flex-row gap-4">
                    <input type="url" name="list_url" placeholder="Kategori/Arşiv linki (https://...)"
                        class="flex-grow shadow-sm focus:ring-teal-500 focus:border-teal-500 block w-full sm:text-sm bg-gray-700 border-gray-600 text-white rounded-md"
                        required>
                    <button type="submit"
                        class="inline-flex justify-center items-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700">Toplu
                        Ekle</button>
                </form>
            </div>
        </div>

        <div class="bg-gray-800 shadow-lg rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-white">İndirme Kuyruğu</h3>
                <form action="{{ url_for('toggle_auto_download') }}" method="post">
                    <button type="submit" id="auto-download-btn"
                        class="px-4 py-2 text-sm font-medium rounded-md"></button>
                </form>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-2/12">
                                Durum</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">
                                Poster</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-6/12">
                                Film Bilgileri</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-3/12">
                                İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="video-queue-body" class="bg-gray-800 divide-y divide-gray-700">
                        {% for video in videos %}
                        <tr id="video-row-{{ video.id }}">
                            <td class="px-6 py-4 whitespace-nowrap align-top">
                                <span id="status-text-{{ video.id }}"
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-{{ video.status.split(':')[0]|lower|replace(' ', '')|replace('ı', 'i') }}">{{
                                    video.status }}</span>
                                <div id="progress-container-{{ video.id }}" class="mt-2 w-full progress-bar-container"
                                    style="display: none;">
                                    <div id="progress-bar-{{ video.id }}"
                                        class="progress-bar flex items-center justify-center text-xs font-medium"
                                        style="width: 0%;"><span id="progress-text-{{ video.id }}">0%</span></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 align-top">
                                <img id="poster-{{ video.id }}"
                                    src="{{ video.poster_url or 'https://via.placeholder.com/100x150.png?text=Poster+Yok' }}"
                                    alt="Film Posteri" class="w-20 rounded shadow-lg">
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-300 align-top">
                                <div class="font-bold text-base text-indigo-400">{{ video.title or 'Başlık Bilinmiyor'
                                    }}</div>
                                <div class="mt-1"><span class="font-semibold">IMDb:</span> <span
                                        class="text-yellow-400 font-bold">{{ video.imdb_score }}</span> | <span
                                        class="font-semibold">Yıl:</span> {{ video.year }} | <span
                                        class="font-semibold">Tür:</span> {{ video.genre }}</div>
                                <p class="mt-2 text-xs text-gray-400 max-h-24 overflow-auto">{{ video.description }}</p>
                                <div class="mt-2 text-xs">
                                    <p class="text-gray-400"><span class="font-semibold">Yönetmen:</span> {{
                                        video.director }}</p>
                                    <p class="text-gray-400 truncate"><span class="font-semibold">Oyuncular:</span> {{
                                        video.cast }}</p>
                                </div>
                                <div class="mt-2 text-xs text-gray-500 truncate" title="{{ video.url }}">{{ video.url }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium align-top">
                                <div id="actions-{{ video.id }}" class="flex items-center space-x-4">
                                    {% if video.status in ['Kaynak aranıyor...', 'İndiriliyor'] %}
                                    <form action="{{ url_for('stop_download', video_id=video.id) }}" method="post">
                                        <button type="submit" class="btn btn-yellow font-semibold">Durdur</button>
                                    </form>
                                    {% elif video.status == 'Tamamlandı' %}
                                    <form action="{{ url_for('start_download', video_id=video.id) }}" method="post">
                                        <button type="submit" class="btn btn-blue font-semibold">Yeniden İndir</button>
                                    </form>
                                    {% if video.filepath %}<form
                                        action="{{ url_for('delete_file', video_id=video.id) }}" method="post"
                                        onsubmit="return confirm('Bu dosyayı diskten kalıcı olarak silmek istediğinizden emin misiniz?');">
                                        <button type="submit" class="btn btn-purple font-semibold">Disk'ten Sil</button>
                                    </form>{% endif %}
                                    {% else %}
                                    <form action="{{ url_for('start_download', video_id=video.id) }}" method="post">
                                        <button type="submit" class="btn btn-green font-semibold">Başlat</button></form>
                                    {% endif %}
                                    <form action="{{ url_for('delete_video', video_id=video.id) }}" method="post"
                                        onsubmit="return confirm('Bu kaydı silmek istediğinizden emin misiniz?');">
                                        <button type="submit" class="btn btn-red font-semibold">Sil</button></form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr id="no-videos-row">
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Kuyruk boş.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <footer class="text-center text-sm text-gray-500 py-4 mt-4">Sürüm {{ version }}</footer>
    </main>
    <script>
        // --- YENİ: Akıcı Arayüz Güncelleme Scripti ---
        function createVideoRow(video) {
            const statusSimple = (video.status || '').split(':')[0].toLowerCase().replace(/[^a-z0-9]/gi, '');
            const actionsHtml = createActionsHtml(video);

            return `
                <td class="px-6 py-4 whitespace-nowrap align-top">
                    <span id="status-text-${video.id}" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${statusSimple}">${video.status || ''}</span>
                    <div id="progress-container-${video.id}" class="mt-2 w-full progress-bar-container" style="display: none;">
                        <div id="progress-bar-${video.id}" class="progress-bar flex items-center justify-center text-xs font-medium" style="width: 0%;"><span id="progress-text-${video.id}">0%</span></div>
                    </div>
                </td>
                <td class="px-6 py-4 align-top">
                    <img id="poster-${video.id}" src="${video.poster_url || 'https://via.placeholder.com/100x150.png?text=Poster+Yok'}" alt="Film Posteri" class="w-20 rounded shadow-lg">
                </td>
                <td class="px-6 py-4 text-sm text-gray-300 align-top">
                    <div class="font-bold text-base text-indigo-400">${video.title || 'Başlık Bilinmiyor'}</div>
                    <div class="mt-1"><span class="font-semibold">IMDb:</span> <span class="text-yellow-400 font-bold">${video.imdb_score || 'N/A'}</span> | <span class="font-semibold">Yıl:</span> ${video.year || 'N/A'} | <span class="font-semibold">Tür:</span> ${video.genre || 'N/A'}</div>
                    <p class="mt-2 text-xs text-gray-400 max-h-24 overflow-auto">${video.description || ''}</p>
                    <div class="mt-2 text-xs"><p class="text-gray-400"><span class="font-semibold">Yönetmen:</span> ${video.director || 'N/A'}</p><p class="text-gray-400 truncate"><span class="font-semibold">Oyuncular:</span> ${video.cast || 'N/A'}</p></div>
                    <div class="mt-2 text-xs text-gray-500 truncate" title="${video.url || ''}">${video.url || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium align-top">
                    <div id="actions-${video.id}" class="flex items-center space-x-4">${actionsHtml}</div>
                </td>
            `;
        }

        function createActionsHtml(video) {
            let html = '';
            const isWorking = ['Kaynak aranıyor...', 'İndiriliyor'].includes(video.status);

            if (isWorking) {
                html += `<form action="/stop/${video.id}" method="post"><button type="submit" class="btn btn-yellow font-semibold">Durdur</button></form>`;
            } else if (video.status === 'Tamamlandı') {
                html += `<form action="/start/${video.id}" method="post"><button type="submit" class="btn btn-blue font-semibold">Yeniden İndir</button></form>`;
                if (video.filepath) {
                    html += `<form action="/delete_file/${video.id}" method="post" onsubmit="return confirm('Bu dosyayı diskten kalıcı olarak silmek istediğinizden emin misiniz?');"><button type="submit" class="btn btn-purple font-semibold">Disk'ten Sil</button></form>`;
                }
            } else {
                html += `<form action="/start/${video.id}" method="post"><button type="submit" class="btn btn-green font-semibold">Başlat</button></form>`;
            }
            html += `<form action="/delete/${video.id}" method="post" onsubmit="return confirm('Bu kaydı silmek istediğinizden emin misiniz?');"><button type="submit" class="btn btn-red font-semibold">Sil</button></form>`;
            return html;
        }

        function updateUI() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) window.location.reload();
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const videos = data.videos;
                    const autoDownloadEnabled = data.auto_download_enabled;
                    const autoDownloadBtn = document.getElementById('auto-download-btn');
                    const videoQueueBody = document.getElementById('video-queue-body');

                    // Otomatik indirme butonunu güncelle
                    if (autoDownloadEnabled) {
                        autoDownloadBtn.textContent = 'Otomatik İndirmeyi Durdur';
                        autoDownloadBtn.className = 'px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700';
                    } else {
                        autoDownloadBtn.textContent = 'Otomatik İndirmeyi Başlat';
                        autoDownloadBtn.className = 'px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700';
                    }

                    const receivedVideoIds = new Set(Object.keys(videos).map(id => parseInt(id)));
                    const displayedVideoRows = videoQueueBody.querySelectorAll('tr[id^="video-row-"]');
                    const displayedVideoIds = new Set(Array.from(displayedVideoRows).map(row => parseInt(row.id.replace('video-row-', ''))));

                    // Silinmiş videoları UI'dan kaldır
                    displayedVideoRows.forEach(row => {
                        const videoId = parseInt(row.id.replace('video-row-', ''));
                        if (!receivedVideoIds.has(videoId)) {
                            row.remove();
                        }
                    });

                    // Yeni ve mevcut videoları güncelle/ekle
                    for (const id in videos) {
                        const video = videos[id];
                        let row = document.getElementById(`video-row-${id}`);

                        if (!row) { // Video UI'da yoksa, yeni satır oluştur
                            row = document.createElement('tr');
                            row.id = `video-row-${id}`;
                            row.innerHTML = createVideoRow(video);
                            videoQueueBody.appendChild(row);
                        } else { // Video UI'da varsa, içeriğini güncelle
                            // Durum ve ilerleme
                            const statusText = document.getElementById(`status-text-${id}`);
                            const progressContainer = document.getElementById(`progress-container-${id}`);
                            const progressBar = document.getElementById(`progress-bar-${id}`);
                            const progressText = document.getElementById(`progress-text-${id}`);

                            const simpleStatus = (video.status || '').split(':')[0].toLowerCase().replace(/[^a-z0-9]/gi, '');
                            statusText.textContent = video.status;
                            statusText.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${simpleStatus}`;

                            const isWorking = ['Kaynak aranıyor...', 'İndiriliyor'].includes(video.status);
                            const isDone = video.status === 'Tamamlandı';

                            if (isWorking || (isDone && video.progress === 100)) {
                                progressContainer.style.display = 'block';
                                const currentProgress = Math.floor(video.progress || 0);
                                progressBar.style.width = `${currentProgress}%`;
                                progressText.textContent = `${currentProgress}%`;
                            } else {
                                progressContainer.style.display = 'none';
                            }

                            // Aksiyon butonlarını güncelle
                            document.getElementById(`actions-${id}`).innerHTML = createActionsHtml(video);
                        }
                    }

                    // Kuyruk boşsa mesaj göster
                    const noVideosRow = document.getElementById('no-videos-row');
                    if (receivedVideoIds.size === 0 && !noVideosRow) {
                        videoQueueBody.innerHTML = '<tr id="no-videos-row"><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Kuyruk boş.</td></tr>';
                    } else if (receivedVideoIds.size > 0 && noVideosRow) {
                        noVideosRow.remove();
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        document.addEventListener('DOMContentLoaded', updateUI);
        setInterval(updateUI, 2500);
    </script>
</body>

</html>